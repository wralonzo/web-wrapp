<app-modal [(isOpen)]="showModal" [isValid]="userForm.valid ?? false" [isSubmitting]="loading()"
  (onConfirm)="submitForm()" title="Cambiar Contraseña" confirmText="Cambiar Contraseña" cancelText="Cancelar"
  (onCancel)="onCancel()">
  <form #userForm="ngForm" class="space-y-4">
    <app-input name="password" label="Nueva Contraseña" [(ngModel)]="formData().password" [required]="true"
      [maxlength]="100" [minLength]="8" type="password"></app-input>

    <app-input name="confirmPassword" label="Confirmar Contraseña" [(ngModel)]="formData().confirmPassword"
      [required]="true" [maxlength]="100" [minLength]="8" type="password"></app-input>

    <div>
      <label class="text-[10px] font-black text-text-muted uppercase ml-1 tracking-widest">Motivo del cambio</label>
      <select name="reason" [(ngModel)]="formData().reason"
        class="w-full bg-bg-secondary border border-border p-4 rounded-2xl outline-none text-text-primary focus:ring-4 focus:ring-primary/10 transition-all font-bold mt-2 shadow-sm appearance-none cursor-pointer"
        required>
        <option value="" disabled selected hidden>Selecciona una opción corporativa</option>
        <option value="security">Protocolo de seguridad periódica</option>
        <option value="reset">Reinicio solicitado por el usuario</option>
      </select>
    </div>
  </form>
</app-modal>

<div class="max-w-4xl mx-auto p-6 transition-colors duration-300">
  @if (isLoading()) {
  <div
    class="animate-pulse bg-bg-secondary rounded-[32px] p-8 space-y-4 shadow-sm border border-border transition-colors duration-300">
    <div class="flex items-center gap-4">
      <div class="w-16 h-16 bg-bg-primary rounded-2xl border border-border"></div>
      <div class="space-y-2">
        <div class="h-4 w-32 bg-bg-primary rounded"></div>
        <div class="h-3 w-20 bg-bg-primary rounded"></div>
      </div>
    </div>
    <div class="h-24 w-full bg-bg-primary/50 rounded-2xl"></div>
  </div>
  } @else if (user(); as u) {
  <div
    class="bg-bg-secondary rounded-[40px] shadow-2xl border border-border overflow-hidden transition-colors duration-300">
    <div
      class="p-10 flex flex-col lg:flex-row items-start lg:items-center justify-between bg-bg-primary/50 border-b border-border gap-8">
      <div class="flex items-center gap-6">
        <div
          class="w-24 h-24 rounded-[32px] bg-primary/10 border-2 border-primary/20 flex items-center justify-center text-primary text-3xl font-black shadow-inner relative group overflow-hidden">
          @if (u.profile.avatar) {
          <img [src]="u.profile.avatar" class="w-full h-full object-cover rounded-[32px]" />
          } @else {
          {{ getInitials(u.profile.fullName) }}
          }
          <div class="absolute inset-0 bg-primary/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
        </div>
        <div>
          <h1 class="text-3xl font-black text-text-primary tracking-tighter uppercase leading-none mb-2">{{
            u.profile.fullName }}</h1>
          <div class="flex items-center gap-2">
            <span class="text-text-muted font-bold text-sm tracking-tight">ID: {{ u.user.id }}</span>
            <span class="w-1 h-1 bg-border rounded-full"></span>
            <p class="text-text-secondary font-black text-sm uppercase tracking-widest">{{ u.profile.username }}</p>
          </div>

          @if (u.profile.passwordInit) {
          <div
            class="mt-5 flex items-center gap-3 p-4 bg-amber-500/10 border border-amber-500/20 rounded-2xl w-fit shadow-sm relative overflow-hidden group">
            <div
              class="absolute inset-0 bg-amber-500/5 -translate-x-full group-hover:translate-x-full transition-transform duration-1000">
            </div>
            <div class="flex flex-col relative z-10">
              <span class="text-[9px] font-black text-amber-700 uppercase tracking-[0.2em]">Credenciales
                Temporales</span>
              <p class="text-amber-800 font-mono font-black text-xl tracking-tighter">{{ u.profile.passwordInit }}</p>
            </div>

            <button (click)="copyToClipboard(u.profile.passwordInit)" title="Copiar contraseña"
              class="ml-2 p-2.5 bg-white/50 dark:bg-black/20 text-amber-700 hover:bg-amber-500 hover:text-white rounded-xl transition-all active:scale-95 border border-amber-500/20 shadow-sm relative z-10">
              @if (isCopied()) {
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-width="3" d="M5 13l4 4L19 7" />
              </svg>
              } @else {
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5"
                stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184" />
              </svg>
              }
            </button>
          </div>
          }
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-4">
        <button [title]="u.user.enabled ? 'Desactivar acceso corporativo' : 'Activar acceso corporativo'"
          (click)="toggleStatus()"
          [class]="u.user.enabled ? 'bg-emerald-500 shadow-emerald-500/30' : 'bg-rose-500 shadow-rose-500/30'"
          class="px-6 py-3 rounded-2xl text-white text-xs font-black shadow-xl transition-all hover:scale-105 active:scale-95 uppercase tracking-widest border border-white/10">
          <span class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-white animate-pulse"></span>
            {{ u.user.enabled ? 'ACTIVO' : 'INACTIVO' }}
          </span>
        </button>
        <a title="Volver al directorio" [routerLink]="ROUTES.nav.users.list"
          class="text-text-muted hover:text-text-primary transition-all flex items-center justify-center w-12 h-12 bg-bg-primary rounded-2xl border border-border shadow-sm hover:border-text-muted hover:scale-105 active:scale-95">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </a>
      </div>
    </div>

    <div class="p-10 grid grid-cols-1 md:grid-cols-2 gap-16 bg-bg-secondary transition-colors duration-300">
      <div class="space-y-8">
        <h4 class="text-[10px] font-black text-text-muted uppercase tracking-[0.3em] mb-6">Canales de Contacto</h4>
        <div class="space-y-6">
          <div class="flex items-center gap-5 text-text-secondary group">
            <div
              class="w-14 h-14 rounded-[22px] bg-bg-primary border-2 border-border flex items-center justify-center text-text-muted group-hover:border-primary/30 group-hover:text-primary transition-all shadow-sm">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-width="2.5"
                  d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
              </svg>
            </div>
            <div class="flex flex-col">
              <span class="text-[10px] font-black text-text-muted uppercase tracking-widest mb-1">Línea Directa</span>
              <span class="text-lg font-black text-text-primary tracking-tight">{{ u.profile.phone || 'No asignado'
                }}</span>
            </div>
          </div>
          <div class="flex items-center gap-5 text-text-secondary group">
            <div
              class="w-14 h-14 rounded-[22px] bg-bg-primary border-2 border-border flex items-center justify-center text-text-muted group-hover:border-primary/30 group-hover:text-primary transition-all shadow-sm">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-width="2.5"
                  d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-width="2.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
            </div>
            <div class="flex flex-col">
              <span class="text-[10px] font-black text-text-muted uppercase tracking-widest mb-1">Ubicación
                Registrada</span>
              <span class="text-sm font-bold text-text-primary leading-tight max-w-[280px]">{{ u.profile.address || 'Sin
                dirección'
                }}</span>
            </div>
          </div>
        </div>

        <div class="pt-8 border-t border-border">
          <h4 class="text-[10px] font-black text-text-muted uppercase tracking-[0.3em] mb-4">Roles de Privilegio</h4>
          <div class="flex flex-wrap gap-2">
            @for (role of u.roles; track role) {
            <span
              class="px-4 py-2 bg-primary/5 border-2 border-primary/20 text-primary text-[11px] font-black rounded-xl uppercase tracking-wider shadow-sm">
              {{ role.replace('ROLE_', '') }}
            </span>
            }
          </div>
        </div>
      </div>

      @if (u.employee) {
      <div class="space-y-8">
        <h4 class="text-[10px] font-black text-text-muted uppercase tracking-[0.3em] mb-6">Estructura Organizacional
        </h4>
        <div
          class="p-8 bg-primary/5 rounded-[40px] border-2 border-primary/10 relative overflow-hidden group shadow-inner">
          <div
            class="absolute -right-10 -top-10 w-40 h-40 bg-primary/10 rounded-full blur-[80px] group-hover:bg-primary/20 transition-all duration-700">
          </div>
          <div class="relative space-y-8">
            <div class="pb-6 border-b border-primary/10">
              <p class="text-[10px] text-primary font-black uppercase tracking-[0.2em] mb-3">Posición Estratégica</p>
              <p class="text-3xl font-black text-text-primary leading-[0.9] tracking-tighter uppercase">{{
                u.employee.positionName }}</p>
            </div>
            <div class="flex items-center gap-4">
              <div
                class="w-12 h-12 bg-bg-primary rounded-2xl flex items-center justify-center border border-primary/10 text-primary shadow-sm">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-width="2.5"
                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
              </div>
              <div>
                <p class="text-[10px] text-text-muted font-black uppercase tracking-tighter mb-1">Localidad de Operación
                </p>
                <p class="text-base font-black text-text-secondary uppercase tracking-tight">{{ u.employee.warehouseName
                  }}</p>
              </div>
            </div>
          </div>
        </div>

        <div
          class="p-6 border-2 border-dashed border-border rounded-[32px] flex items-center gap-4 opacity-60 hover:opacity-100 transition-opacity">
          <div class="w-10 h-10 rounded-full bg-bg-secondary flex items-center justify-center text-text-muted">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-width="2.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <p class="text-[10px] font-bold text-text-muted uppercase leading-tight tracking-tight">Historial de actividad
            corporativa auditado por el sistema de seguridad global.</p>
        </div>
      </div>
      }
    </div>

    <div class="p-10 bg-bg-primary/50 border-t border-border flex flex-col sm:flex-row gap-6">
      <app-button class="flex-1 shadow-lg" label="Reestablecer Seguridad" btnType="secondary" icon="refresh"
        (btnClick)="changePassword()"></app-button>
      <app-button class="flex-1 shadow-xl" label="Modificar Perfil Élite" icon="edit"
        (btnClick)="editUser()"></app-button>
    </div>
  </div>
  } @else {
  <div
    class="text-center p-32 bg-bg-secondary rounded-[40px] border-2 border-dashed border-border transition-colors duration-300 shadow-inner">
    <div
      class="w-20 h-20 bg-bg-primary rounded-[28px] border border-border flex items-center justify-center mx-auto mb-8 text-text-muted/20">
      <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </div>
    <h3 class="text-2xl font-black text-text-primary uppercase tracking-tighter mb-4">Registro Externo</h3>
    <p class="text-text-muted font-bold tracking-tight mb-10 max-w-sm mx-auto">No se ha podido localizar el expediente
      digital asociado a este identificador en la base de datos corporativa.</p>
    <app-button label="Volver al Directorio Global" btnType="secondary"
      (btnClick)="nav.push(ROUTES.nav.users.list)"></app-button>
  </div>
  }
</div>